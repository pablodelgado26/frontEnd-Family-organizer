'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import axios from 'axios';
import { useAuth } from '../../../contexts/AuthContext';
import { useFamily } from '../../../contexts/FamilyContext';
import ProtectedRoute from '../../../components/ProtectedRoute';
import SuccessModal from './SuccessModal';
import styles from './page.module.css';

function CreateFamilyContent() {
  const router = useRouter();
  const { user } = useAuth();
  const { refreshGroups } = useFamily();
  const [formData, setFormData] = useState({
    familyName: ''
  });
  const [inviteCode, setInviteCode] = useState('');
  const [showSuccess, setShowSuccess] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const [joinCode, setJoinCode] = useState('');

  const handleInputChange = (e) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
    if (error) setError('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    try {
      const token = localStorage.getItem('token');
      const response = await axios.post('http://localhost:4000/family-groups', {
        name: formData.familyName
      }, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      // A API retorna { message: "...", familyGroup: { id, name, inviteCode, ... } }
      const newGroup = response.data.familyGroup || response.data;
      setInviteCode(newGroup.inviteCode);
      setShowSuccess(true);
      
      // Atualizar lista de grupos
      await refreshGroups();
      
    } catch (error) {
      console.error('Erro ao criar fam√≠lia:', error);
      setError(error.response?.data?.message || 'Erro ao criar fam√≠lia');
    } finally {
      setIsLoading(false);
    }
  };

  const handleJoinGroup = async (e) => {
    e.preventDefault();
    if (!joinCode.trim()) return;
    
    setIsLoading(true);
    setError('');

    try {
      const token = localStorage.getItem('token');
      const code = joinCode.trim().toUpperCase();
      
      console.log('üîë C√≥digo digitado:', code);
      console.log('üîë Tamanho do c√≥digo:', code.length);
      console.log('ü™ô Token presente:', !!token);
      
      let response;
      let success = false;
      
      // Tentar primeiro com endpoint de c√≥digo tempor√°rio (6 caracteres)
      if (code.length === 6) {
        try {
          console.log('üì° Tentando /family-groups/join-temp com c√≥digo de 6 d√≠gitos');
          response = await axios.post('http://localhost:4000/family-groups/join-temp', {
            tempInviteCode: code
          }, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          console.log('‚úÖ Sucesso com join-temp:', response.data);
          success = true;
        } catch (tempError) {
          console.log('‚ùå join-temp falhou:', tempError.response?.status, tempError.response?.data);
        }
      }
      
      // Se n√£o teve sucesso, tentar endpoint regular (c√≥digo permanente)
      if (!success) {
        console.log('üì° Tentando /family-groups/join com c√≥digo permanente');
        console.log('üì¶ Payload sendo enviado:', { inviteCode: code });
        console.log('üîê Headers:', {
          'Authorization': `Bearer ${token ? token.substring(0, 20) + '...' : 'AUSENTE'}`,
          'Content-Type': 'application/json'
        });
        
        try {
          response = await axios.post('http://localhost:4000/family-groups/join', {
            inviteCode: code
          }, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          console.log('‚úÖ Sucesso com join:', response.data);
          success = true;
        } catch (joinError) {
          console.log('‚ùå join tamb√©m falhou');
          console.log('‚ùå Status code:', joinError.response?.status);
          console.log('‚ùå Status text:', joinError.response?.statusText);
          console.log('‚ùå Response data:', joinError.response?.data);
          console.log('‚ùå Response headers:', joinError.response?.headers);
          console.log('‚ùå Request data:', joinError.config?.data);
          throw joinError; // Re-throw para ser capturado pelo catch externo
        }
      }
      
      if (!success) {
        throw new Error('N√£o foi poss√≠vel entrar na fam√≠lia com este c√≥digo');
      }
      
      console.log('‚úÖ Entrada na fam√≠lia bem-sucedida');
      alert('‚úÖ Voc√™ entrou na fam√≠lia com sucesso!');
      
      // Atualizar lista de grupos
      await refreshGroups();
      
      // Redirecionar para o dashboard
      router.push('/dashboard');
      
    } catch (error) {
      console.error('‚ùå Erro final ao entrar na fam√≠lia:', error);
      console.error('Status:', error.response?.status);
      console.error('Detalhes:', error.response?.data);
      
      let errorMessage = 'C√≥digo inv√°lido ou expirado';
      
      if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.response?.data?.error) {
        errorMessage = error.response.data.error;
      } else if (error.response?.status === 400) {
        errorMessage = 'C√≥digo inv√°lido. Verifique se digitou corretamente.';
      } else if (error.response?.status === 404) {
        errorMessage = 'C√≥digo n√£o encontrado ou expirado.';
      } else if (error.response?.status === 409) {
        errorMessage = 'Voc√™ j√° faz parte desta fam√≠lia.';
      }
      
      setError(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({ familyName: '' });
    setInviteCode('');
    setShowSuccess(false);
    setError('');
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(inviteCode);
    alert('C√≥digo copiado para a √°rea de transfer√™ncia!');
  };

  return (
    <>
      <SuccessModal
        isOpen={showSuccess}
        onClose={resetForm}
        familyName={formData.familyName}
        inviteCode={inviteCode}
        onGoToDashboard={() => router.push('/dashboard')}
      />
      
      <div className={styles.container}>
        <div className={styles.header}>
          <Link href="/dashboard" className={styles.backLink}>
            ‚Üê Voltar ao painel
          </Link>
        </div>
        
        <div className={styles.formContainer}>
          <div className={styles.optionsContainer}>
            <div className={styles.optionCard}>
              <h2 className={styles.optionTitle}>Criar Nova Fam√≠lia</h2>
              <p className={styles.optionDescription}>
                Crie um novo grupo familiar e convide outros membros.
              </p>
              
              {error && (
                <div className={styles.error}>
                  {error}
                </div>
              )}

              <form className={styles.form} onSubmit={handleSubmit}>
                <div className="form-group">
                  <label htmlFor="familyName">Nome da fam√≠lia</label>
                  <input
                    type="text"
                    id="familyName"
                    name="familyName"
                    value={formData.familyName}
                    onChange={handleInputChange}
                    required
                    placeholder="Ex: Fam√≠lia Silva, Casa dos Garcia..."
                  />
                </div>

                <button 
                  type="submit" 
                  className="btn btn-primary" 
                  style={{ width: '100%' }}
                  disabled={isLoading}
                >
                  {isLoading ? 'Criando...' : 'Criar Fam√≠lia'}
                </button>
              </form>
            </div>

            <div className={styles.separator}>OU</div>

            <div className={styles.optionCard}>
              <h2 className={styles.optionTitle}>Entrar numa Fam√≠lia</h2>
              <p className={styles.optionDescription}>
                Pe√ßa ao administrador do grupo para gerar um c√≥digo de convite tempor√°rio.
              </p>

              <form className={styles.form} onSubmit={handleJoinGroup}>
                <div className="form-group">
                  <label htmlFor="joinCode">
                    C√≥digo de Convite (6 caracteres)
                  </label>
                  <input
                    type="text"
                    id="joinCode"
                    value={joinCode}
                    onChange={(e) => {
                      setJoinCode(e.target.value.toUpperCase());
                      if (error) setError('');
                    }}
                    required
                    placeholder="Ex: ABC123"
                    maxLength={6}
                    style={{ textTransform: 'uppercase' }}
                  />
                  <small style={{ color: 'var(--gray-600)', fontSize: '0.85rem', marginTop: '8px', display: 'block' }}>
                    ‚è±Ô∏è C√≥digos s√£o v√°lidos por apenas 15 minutos
                  </small>
                </div>

                <button 
                  type="submit" 
                  className="btn btn-secondary" 
                  style={{ width: '100%' }}
                  disabled={isLoading}
                >
                  {isLoading ? 'Entrando...' : 'Entrar na Fam√≠lia'}
                </button>
              </form>
            </div>
          </div>

          <div className={styles.info}>
            <h3>Como funciona?</h3>
            <div className={styles.infoGrid}>
              <div className={styles.infoItem}>
                <span className={styles.infoIcon}>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                <h4>Crie ou Entre</h4>
                <p>Crie uma nova fam√≠lia ou entre numa existente com um c√≥digo</p>
              </div>
              <div className={styles.infoItem}>
                <span className={styles.infoIcon}>üîó</span>
                <h4>Compartilhe</h4>
                <p>Convide outros membros compartilhando o c√≥digo de convite</p>
              </div>
              <div className={styles.infoItem}>
                <span className={styles.infoIcon}>üì±</span>
                <h4>Organize</h4>
                <p>Gerencie consultas, eventos, anota√ß√µes e mem√≥rias em fam√≠lia</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}

export default function CreateFamily() {
  return (
    <ProtectedRoute>
      <CreateFamilyContent />
    </ProtectedRoute>
  );
}